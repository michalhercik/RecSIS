package coursedetail

import (
    "github.com/michalhercik/RecSIS/utils"
    "strconv"
	"strings"
    "fmt"
    // TODO should use this for sanitizing? might use own policy
    "github.com/microcosm-cc/bluemonday"
)

const user = 42

var p *bluemonday.Policy

func itos(i int) string {
    return strconv.Itoa(i)
}

templ Ratings(ratings CourseRatings, courseCode string) {
    <div id="rating">
        <p class="text-warning">Under construction</p> // TODO: remove
        Overall Rating: { ratings.Overall.String() }
        <button hx-post={ fmt.Sprintf("/course/like/%s", courseCode) } hx-target="#rating" hx-swap="outerHTML">Like</button>
        <button hx-post={ fmt.Sprintf("/course/dislike/%s", courseCode) } hx-target="#rating" hx-swap="outerHTML">Dislike</button>
        Difficulty Rating: { ratings.Difficulty.String() }
        Workload Rating: { ratings.Workload.String() }
        Usefulness Rating: { ratings.Usefulness.String() }
        Fun Rating: { ratings.Fun.String() }
    </div>
}

templ blueprintAssignment(code string, t text) {
    <div class="d-flex justify-content-center">
        <div class="btn-group">
            <button type="button" class="btn btn-lg btn-outline-blueprint"
                hx-post={ "/blueprint/course/" + code }  
                hx-vals={ `"year": 0, "semester": 0, "lang": "` + t.Language + `"` }
            >
                { t.Assign }
            </button>
            <button type="button" class="btn btn-lg btn-outline-blueprint dropdown-toggle dropdown-toggle-split"
                data-bs-toggle="dropdown" aria-expanded="false">
            </button>
            <ul class="dropdown-menu">
            // TODO: make dynamic, NOT 3 fixed years
                for year := 1; year <= 3; year++ {
                    <li class="mx-3"><button class="dropdown-item text-center"
                        hx-post={ "/blueprint/course/" + code }  
                        hx-vals={ `"year": ` + strconv.Itoa(year) + `, "semester": 1, "lang": "` + t.Language + `"` } 
                    >
                    { t.YearStr(year) + " " + t.Winter }
                    </button></li>
                    <li class="mx-3"><button class="dropdown-item text-center"
                        hx-post={ "/blueprint/course/" + code }  
                        hx-vals={ `"year": ` + strconv.Itoa(year) + `, "semester": 2, "lang": "` + t.Language + `"` } 
                    >
                    { t.YearStr(year) + " " + t.Summer }
                    </button></li>
                }
            </ul>
        </div>
    </div>
}

func semesterHoursExamsString(course *Course, t text) string {
    result := ""
    if course.SemesterCount == 1 {
        result = course.Start + " " + strconv.Itoa(course.LectureRange1) + "/" + strconv.Itoa(course.SeminarRange1) + ", " + course.ExamType
    } else if course.SemesterCount == 2 {
        // TODO: either implement this logic
        //      A) here, switch starting semester and add language support
        //      B) in db meaning LectureRange1 is for winter semester and LectureRange2 for summer semester - THIS OK
    } else {
        result = "unsupported"
    }
    return result
}

func courseSISLink(code string, t text) string {
    if t.Language == "cs" {
        return "https://is.cuni.cz/studium/predmety/index.php?do=predmet&kod=" + code
    } else if t.Language == "en" {
        return "https://is.cuni.cz/studium/eng/predmety/index.php?do=predmet&kod=" + code
    }
    return "unsupported language"
}

templ renderSafeContent(content string) {
    // prefix <HTML> -> probably HTML content
    if strings.HasPrefix(content, "<HTML>") {
    // TODO not sure that table is best practice, but it works
    <table><tr><td>
    @templ.Raw(p.Sanitize(content))
    </td></tr></table>
    } else {
    // otherwise looks like markdown
    // TODO add some renderer for "markdown"
        { content }
    }
}

templ accordionItem(desc Description, id string) {
    if desc.Content != "" {
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button fs-4" type="button" data-bs-toggle="collapse" data-bs-target={ "#panel-" + id } aria-expanded="true" aria-controls={ "panel-" + id }>
                { utils.CapitalizeFirstLetter(desc.Title) }
            </button>
        </h2>
        <div id={ "panel-" + id } class="accordion-collapse collapse show">
            <div class="accordion-body">
                <p style="text-align: justify">@renderSafeContent(desc.Content)</p>
            </div>
        </div>
    </div>
    }
}

templ ribbon(ba Assignments, t text) {
    //if len(ba) > 0 {
        <div class="ribbon-detail">
            <span>{ ba.String(t.Language) }</span>
        </div>
    //}
}

templ guarantors(guarantors []Teacher) {
    <p
        class="card-subtitle mb-2 text-muted text-center">
        for _, g := range guarantors {
            if g.TitleBefore != "" {
                <small style="font-size: 0.75rem;">{ g.TitleBefore + " " }</small>
            }
            if g.TitleAfter != "" {
                <span class="fs-5 text-dark fw-semibold">{ g.FirstName + " " + g.LastName }</span><small style="font-size: 0.75rem;">{ ", " + g.TitleAfter }</small>
            } else {
                <span class="fs-5 text-dark fw-semibold">{ g.FirstName + " " + g.LastName }</span>
            }
            // space between guarantors
            &emsp;
        }
    </p>
}

templ accordion(course *Course, t text) {
    <div class="accordion accordion-flush">
        @accordionItem(course.Annotation, "annotation")
        @accordionItem(course.CompletionRequirements, "completion-requirements")
        @accordionItem(course.ExamRequirements, "exam-requirements")
        @accordionItem(course.Sylabus, "sylabus")
    </div>
}

templ Content(course *Course, t text) {
    {{ p = bluemonday.UGCPolicy() }}
    //@Ratings(course.CourseRatings, course.Code)
    // TODO only if not empty/nil/...
    <div 
        id="basic-info"
        class="card"
        style="width: 100%;"
    >
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fs-4">{ course.Code }</h6>
            <p class="mb-0 fs-4">{ semesterHoursExamsString(course, t) }</p>
            <p class="mb-0 fs-4">{ t.ECredits + ": " + strconv.Itoa(course.Credits) }</p>
        </div>
        <div class="card-body d-flex flex-column align-items-center position-relative">
            @ribbon(course.BlueprintAssignments, t)
            <h1 class="card-title text-center" style="width: 80%">{ course.Name }</h1>
            @guarantors(course.Guarantors)
        </div>
        <div class="card-body">
            <div class="d-flex justify-content-between" style="padding: 0 5%;">
                <div class="flex-grow-1 d-flex flex-column me-3" style="flex: 1;">
                    <p class="mb-1"><strong>{ t.Faculty }</strong></p>
                    <p class="mb-2">{ course.Faculty }</p>
                    <p class="mb-1"><strong>{ t.Capacity }</strong></p>
                    <p class="mb-2">{ course.Capacity }</p>
                    <p class="mb-1"><strong>{ t.StateOfCourse }</strong></p>
                    <p class="mb-2">{ course.State }</p>
                    <p class="mb-1"><strong>{ t.LanguageOfCourse }</strong></p>
                    <p class="mb-2">{ course.Language }</p>
                    if course.Link != "" {
                        <p class="mb-1"><strong>{ t.AdditionalInfo }</strong></p>
                        <p class="mb-2"><a href={ templ.SafeURL(course.Link) }>{ course.Link }</a></p>
                    }
                </div>
                <div class="flex-grow-1 d-flex flex-column ms-3" style="flex: 1;">
                    if len(course.Teachers) > 0 {
                        <p class="mb-1"><strong>{ t.Teachers }</strong></p>
                        <p class="mb-2">{ course.Teachers[0].String() }</p>
                    }
                    if len(course.Teachers) > 1 {
                        for _, teacher := range course.Teachers[1:] {
                            <p class="mb-2">{ teacher.String() }</p>
                        }
                    }
                </div>
            </div>
            <div class="mt-3 text-center">
                <p><strong>{ t.SISLink + ": " }</strong><a href={ templ.SafeURL(courseSISLink(course.Code, t)) }>{ courseSISLink(course.Code, t) }</a></p>
            </div>
            @blueprintAssignment(course.Code, t)
        </div>
        @accordion(course, t)
    </div>
}

templ Page(course *Course, t text) {
    @utils.Page(course.Code + " - " + course.Name, t.Utils) {
        <div class="container pt-2">
            @Content(course, t)
        </div>
    }
}

templ PageNotFound(code string, t text) {
    @utils.Page("Course not found", t.Utils) {
        @ContentNotFound(code, t)
    }
}

templ ContentNotFound(code string, t text) {
    <h1>{ t.CourseWithCode + code + t.NotFound }</h1>
}